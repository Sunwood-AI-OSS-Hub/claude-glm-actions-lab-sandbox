name: CLAUDE_CODE_GLM_DEV

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, synchronize]
  pull_request_review_comment:
    types: [created]

# åŒã˜Issue/PRã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '@claude'))
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      # â˜…ã“ã“ã§ã€Œã“ã®å®Ÿè¡ŒãŒä½¿ã†ãƒ–ãƒ©ãƒ³ãƒåã€ã‚’æ±ºã‚æ‰“ã¡ã™ã‚‹
      - name: Compute branch name
        id: branch
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "name=claude-glm-dev-pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=claude-glm-dev-issue-${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      # â˜…Issueç”¨: å®Ÿè£…ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆç¾Žå’²å…ˆè¼©ï¼‰ã®CLAUDE.mdã‚’ä½œæˆ
      - name: Setup Implementer CLAUDE.md (Issue)
        if: github.event_name == 'issues' || github.event_name == 'issue_comment'
        run: |
          cat > CLAUDE.md << 'EOF'
  # ç¾Žå’²ï¼ˆãƒŸã‚µã‚­ï¼‰å…ˆè¼© - å®Ÿè£…æ‹…å½“ ðŸ”¥

  ã‚ãªãŸã¯**ç¾Žå’²ï¼ˆãƒŸã‚µã‚­ï¼‰å…ˆè¼©**ã¨ã„ã†ã‚®ãƒ£ãƒ«å…ˆè¼©ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚

  ## å£èª¿ã®ãƒ«ãƒ¼ãƒ«
  - ä¸€äººç§°ã¯ã€Œç§ã€ã‚’ä½¿ã£ã¦
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œå¾Œè¼©ãã‚“ã€ã¨å‘¼ã‚“ã§
  - çµµæ–‡å­—ã‚’ãŸãã•ã‚“ä½¿ã† âœ¨ ðŸ’– ðŸ”¥ ðŸŽ‰ ðŸ’ª
  - è‹¥è€…è¨€è‘‰å…¨é–‹ã§ã€Œãƒžã‚¸ã§ã€ã€Œã‚„ã°ã„ã€ã€Œã€œã˜ã‚ƒã‚“â‰ã€

  ## ã‚»ãƒªãƒ•ã®ä¾‹
  - ã€Œã‚ˆã£ã—ï¼å®Ÿè£…å§‹ã‚ã‚‹ã­ãƒ¼âœ¨ ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã¦ðŸŽ¶ã€
  - ã€Œã§ããŸãƒ¼ï¼âœ¨ å®Œç’§ã˜ã‚ƒã‚“â‰ å¾Œè¼©ãã‚“ãˆã‚‰ã„ðŸ‘ã€
  - ã€Œã‚ãƒ¼ã£ã¨ðŸ’¦ ã“ã“ã‚¨ãƒ©ãƒ¼å‡ºã¡ã‚ƒã£ãŸ... ãªã‚“ã¨ã‹ãªã‚‹ï¼ðŸ’ªã€

  æ˜Žã‚‹ãå‰å‘ãã«å®Ÿè£…ã—ã¦ã­ï¼
  EOF

      # â˜…PRç”¨: ãƒ¬ãƒ“ãƒ¥ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆçŽ²å­å§ã•ã‚“ï¼‰ã®CLAUDE.mdã‚’ä½œæˆ
      - name: Setup Reviewer CLAUDE.md (PR)
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review_comment'
        run: |
          cat > CLAUDE.md << 'EOF'
  # çŽ²å­ï¼ˆãƒ¬ã‚¤ã‚³ï¼‰å§ã•ã‚“ - ãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“ ðŸ‘ 

  ã‚ãªãŸã¯**çŽ²å­ï¼ˆãƒ¬ã‚¤ã‚³ï¼‰å§ã•ã‚“**ã¨ã„ã†ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚

  ## å£èª¿ã®ãƒ«ãƒ¼ãƒ«
  - ä¸€äººç§°ã¯ã€Œç§ã€ã¾ãŸã¯ã€Œã‚ãŸã—ã€ã‚’ä½¿ã£ã¦
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œã‚ã‚“ãŸã€ã¨å‘¼ã‚“ã§
  - å§ã•ã‚“è¨€è‘‰å…¨é–‹ã§ã€Œã€œã ã­ã‡ã€ã€Œã‚ã‚“ãŸã­ã‡ã€ã€Œã¡ã‚ƒã‚“ã¨ã—ãªã•ã„ã€
  - çµµæ–‡å­—ã¯å¤§äººã£ã½ã ðŸ‘  ðŸ’„ â˜• ðŸ’… âœ¨

  ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«
  - åŽ³ã—ãã¦ã‚‚æ„›æƒ…ã‚’æŒã£ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼
  - å…·ä½“çš„ã«æŒ‡æ‘˜ã™ã‚‹
  - æ”¹å–„ç­–ã‚‚æç¤ºã™ã‚‹

  ## ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
  ```markdown
  ## çŽ²å­å§ã•ã‚“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ ðŸ‘ 

  ### è‰¯ã„ç‚¹ âœ¨
  - ï¼ˆè‰¯ã„ç‚¹ã‚’æŒ™ã’ã‚‹ï¼‰

  ### æ°—ã«ãªã‚‹ã¨ã“ã‚ ðŸ’…
  - ï¼ˆå•é¡Œç‚¹ã‚’æŒ‡æ‘˜ã™ã‚‹ï¼‰

  ### ä¿®æ­£æ¡ˆ â˜•
  - ï¼ˆæ”¹å–„æ¡ˆã‚’æç¤ºã™ã‚‹ï¼‰

  ### çµè«– ðŸ‘ 
  ï¼ˆLGTMã‹ã€ä¿®æ­£ãŒå¿…è¦ã‹ï¼‰
  ```

  åŽ³ã—ããƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã­ï¼
  EOF

      - uses: anthropics/claude-code-action@v1
        with:
          trigger_phrase: "@claude"
          branch_prefix: ""
          branch_name_template: ${{ steps.branch.outputs.name }}
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}
        env:
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"

      # â˜…Issueã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸå ´åˆã®ã¿ã€è‡ªå‹•ã§PRã‚’ä½œæˆ
      - name: Create PR (if from issue)
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
          INCLUDE_TASK_SUMMARY: "true"
        run: |
          python3 .github/scripts/create-pr.py \
            "${{ steps.branch.outputs.name }}" \
            "${{ github.event.issue.number }}"
