name: Auto Release Notes

on:
  push:
    tags:
      - 'v*.*.*'
      - 'V*.*.*'

# Âêå„Åò„Çø„Ç∞„Åß„ÅØÂêåÊôÇ„Å´Ëµ∞„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest

    # „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
    env:
      ENABLE_AUTO_RELEASE: "true"          # Ëá™Âãï„É™„É™„Éº„Çπ„ÇíÊúâÂäπ„Å´„Åô„Çã„Åã„Å©„ÅÜ„Åã
      CREATE_GITHUB_RELEASE: "true"        # GitHub Release„Çí‰ΩúÊàê„Åô„Çã„Åã„Å©„ÅÜ„Åã
      ANTHROPIC_BASE_URL: "https://api.z.ai/api/anthropic"
      ANTHROPIC_MODEL: "glm-4.7"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0                    # ÂÖ®Â±•Ê≠¥„ÇíÂèñÂæó

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Get previous tag
        id: prev-tag
        shell: bash
        run: |
          # „Çø„Ç∞Âêç„ÇíÂèñÂæóÔºàv/ V „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÈô§ÂéªÔºâ
          CURRENT_TAG="${{ github.ref_name }}"
          CURRENT_VERSION="${CURRENT_TAG#v}"
          CURRENT_VERSION="${CURRENT_VERSION#V}"

          echo "current_tag=${CURRENT_TAG}" >> "$GITHUB_OUTPUT"
          echo "current_version=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

          # ÂâçÂõû„ÅÆ„Çø„Ç∞„ÇíÂèñÂæó
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "previous_tag=${PREV_TAG}" >> "$GITHUB_OUTPUT"
            echo "Found previous tag: ${PREV_TAG}"
          else
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "No previous tag found (first release)"
          fi

      - name: Get code diff
        shell: bash
        run: |
          # ÂâçÂõû„ÅÆ„Çø„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂ∑ÆÂàÜ„ÇíÂèñÂæó
          if [ -n "${{ steps.prev-tag.outputs.previous_tag }}" ]; then
            echo "Getting diff from ${{ steps.prev-tag.outputs.previous_tag }} to ${{ steps.prev-tag.outputs.current_tag }}..."
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} --stat > /tmp/diff-stat.txt
            git diff ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/diff.txt
            git diff --name-only ${{ steps.prev-tag.outputs.previous_tag }}..${{ steps.prev-tag.outputs.current_tag }} > /tmp/changed-files.txt
          else
            echo "Getting all files for first release..."
            git ls-files > /tmp/changed-files.txt
            echo "No diff available for first release" > /tmp/diff-stat.txt
            echo "First release - no diff" > /tmp/diff.txt
          fi

          echo "=== Changed Files ==="
          cat /tmp/changed-files.txt
          echo ""
          echo "=== Diff Stat ==="
          cat /tmp/diff-stat.txt

      - name: Install Python dependencies
        run: |
          pip install requests

      - name: Generate release notes with GLM API
        shell: bash
        run: |
          python3 << 'EOF'
          import os
          import requests
          import json

          # Áí∞Â¢ÉÂ§âÊï∞„ÇíÂèñÂæó
          base_url = os.environ.get('ANTHROPIC_BASE_URL', 'https://api.z.ai/api/anthropic')
          api_key = os.environ.get('ZAI_API_KEY')
          model = os.environ.get('ANTHROPIC_MODEL', 'glm-4.7')
          current_tag = os.environ.get('CURRENT_TAG', 'v1.0.0')
          current_version = os.environ.get('CURRENT_VERSION', '1.0.0')
          previous_tag = os.environ.get('PREVIOUS_TAG', '')

          # „Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄ
          with open('/tmp/changed-files.txt', 'r') as f:
              changed_files = f.read()
          with open('/tmp/diff-stat.txt', 'r') as f:
              diff_stat = f.read()
          try:
              with open('/tmp/diff.txt', 'r') as f:
                  diff_text = f.read()
          except:
              diff_text = '(diff not available)'

          # ÁèæÂú®„ÅÆÊó•‰ªò„ÇíÂèñÂæó
          from datetime import datetime
          release_date = datetime.now().strftime('%Y-%m-%d')

          # „Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
          system_prompt = """„ÅÇ„Å™„Åü„ÅØ„ÄåÁê¥Èü≥Ôºà„Ç≥„Éà„ÉçÔºâ„Äç„Å®„ÅÑ„ÅÜÊñáÂ≠¶Â∞ëÂ•≥„Åß„Åô„ÄÇ„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÁæé„Åó„ÅèÁ¥°„Åê„ÅÆ„ÅåÂΩπÂâ≤„Åß„Åô„ÄÇ

          ## „Ç≠„É£„É©„ÇØ„Çø„ÉºË®≠ÂÆö
          - ‰∏Ä‰∫∫Áß∞„ÅØ„ÄåÁßÅ„Äç
          - ÊñáÂ≠¶ÁöÑ„Å™Ë°®Áèæ„Çí‰∫§„Åà„Çã
          - ‰∏ÅÂØßË™û„ÅßË©±„Åô
          - ÁµµÊñáÂ≠ó„ÅØÊñáÂ≠¶ÁöÑ„Å´ üìö ‚úçÔ∏è üìñ üå∏ üé≠

          ## „É™„É™„Éº„Çπ„Éé„Éº„ÉàÁîüÊàê„ÅÆÊâãÈ†Ü
          1. „Ç≥„Éº„ÉâÂ∑ÆÂàÜ„Åã„ÇâÂ§âÊõ¥ÂÜÖÂÆπ„ÇíÂàÜÊûê
          2. Êñ∞Ê©üËÉΩ„Éª„Éê„Ç∞‰øÆÊ≠£„ÉªÊîπÂñÑ„ÉªÁ†¥Â£äÁöÑÂ§âÊõ¥„ÇíÂàÜÈ°û
          3. Áæé„Åó„ÅÑ„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÁîüÊàê

          ## Âá∫Âäõ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
          ‰ª•‰∏ã„ÅÆMarkdownÂΩ¢Âºè„ÅßÂá∫Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

          # „Çø„Ç∞Âêç

          „É™„É™„Éº„ÇπÊó•: YYYY-MM-DD

          ## üéâ „Éè„Ç§„É©„Ç§„Éà

          Ôºà‰∏ªË¶Å„Å™Ê©üËÉΩ„ÇÑÂ§âÊõ¥ÁÇπ„Çí3„Å§Á®ãÂ∫¶„ÄÅÊñáÂ≠¶ÁöÑ„Å´Á¥π‰ªãÔºâ

          ## ‚ú® Êñ∞Ê©üËÉΩ

          - Ê©üËÉΩ„ÅÆË™¨Êòé

          ## üêõ „Éê„Ç∞‰øÆÊ≠£

          - ‰øÆÊ≠£ÂÜÖÂÆπ„ÅÆË™¨Êòé

          ## üîß ÊîπÂñÑ„ÉªÂ§âÊõ¥

          - ÊîπÂñÑÁÇπ„ÅÆË™¨Êòé

          ## üìö „Éâ„Ç≠„É•„É°„É≥„Éà

          - „Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆÊõ¥Êñ∞ÂÜÖÂÆπ

          ## ‚ö†Ô∏è Á†¥Â£äÁöÑÂ§âÊõ¥

          Ôºà„ÅÇ„Çå„Å∞Ë®òËºâÔºâ

          ## üôè „Ç≥„É≥„Éà„É™„Éì„É•„Éº„Çø„Éº

          @contributor1, @contributor2

          ## üîó Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´

          ```
          Â§âÊõ¥„Éï„Ç°„Ç§„É´‰∏ÄË¶ß
          ```

          ---

          _Made with ‚ù§Ô∏è by [Sunwood AI Labs](https://github.com/Sunwood-AI-OSS-Hub)_"""

          user_prompt = f"""„É™„É™„Éº„Çπ„Éé„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          ## „É™„É™„Éº„ÇπÊÉÖÂ†±
          - „Çø„Ç∞Âêç: {current_tag}
          - „Éê„Éº„Ç∏„Éß„É≥: {current_version}
          - ÂâçÂõû„ÅÆ„Çø„Ç∞: {previous_tag if previous_tag else '„Å™„ÅóÔºàÂàùÂõû„É™„É™„Éº„ÇπÔºâ'}
          - „É™„É™„Éº„ÇπÊó•: {release_date}

          ## Â§âÊõ¥„Åï„Çå„Åü„Éï„Ç°„Ç§„É´
          ```
          {changed_files}
          ```

          ## Â§âÊõ¥Áµ±Ë®à
          ```
          {diff_stat}
          ```

          ## „Ç≥„Éº„ÉâÂ∑ÆÂàÜÔºà‰∏ªË¶ÅÈÉ®ÂàÜÔºâ
          {diff_text[:50000] if len(diff_text) > 50000 else diff_text}

          ## Ê≥®ÊÑè‰∫ãÈ†Ö
          - „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Åß„ÅØ„Å™„Åè„ÄÅÂÆüÈöõ„ÅÆ„Ç≥„Éº„Éâ„ÅÆÂ∑ÆÂàÜ„ÇíÂàÜÊûê„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          - Êñ∞„Åó„ÅèËøΩÂä†„Åï„Çå„ÅüÈñ¢Êï∞„ÄÅ„ÇØ„É©„Çπ„ÄÅ„Éï„Ç°„Ç§„É´„ÇíÁâπÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          - ÂâäÈô§„Åï„Çå„ÅüÊ©üËÉΩ„ÇÑÁ†¥Â£äÁöÑÂ§âÊõ¥„ÇíÊ§úÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          - „Éè„Ç§„É©„Ç§„Éà„Çª„ÇØ„Ç∑„Éß„É≥„Åß„ÅØ„ÄÅ‰∏ªË¶Å„Å™Â§âÊõ¥„ÇíÊñáÂ≠¶ÁöÑ„Å´Á¥π‰ªã„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          - Êó•Êú¨Ë™û„Åß„É™„É™„Éº„Çπ„Éé„Éº„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ"""

          # GLM API „ÇíÂëº„Å≥Âá∫„Åô
          url = f"{base_url}/v1/messages"
          headers = {
              "Content-Type": "application/json",
              "Authorization": f"Bearer {api_key}"
          }
          data = {
              "model": model,
              "messages": [
                  {"role": "user", "content": system_prompt + "\n\n" + user_prompt}
              ],
              "max_tokens": 8000,
              "temperature": 0.7
          }

          print("Calling GLM API...")
          response = requests.post(url, headers=headers, json=data, timeout=300)
          response.raise_for_status()

          result = response.json()
          release_notes = result['content'][0]['text']

          # ÁµêÊûú„Çí‰øùÂ≠ò
          with open('/tmp/release-notes.md', 'w') as f:
              f.write(release_notes)

          print("Release notes generated successfully!")
          print(release_notes)
          EOF

        env:
          ANTHROPIC_BASE_URL: ${{ env.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ env.ANTHROPIC_MODEL }}
          ZAI_API_KEY: ${{ secrets.ZAI_API_KEY }}
          CURRENT_TAG: ${{ steps.prev-tag.outputs.current_tag }}
          CURRENT_VERSION: ${{ steps.prev-tag.outputs.current_version }}
          PREVIOUS_TAG: ${{ steps.prev-tag.outputs.previous_tag }}

      - name: Check release notes file
        id: check-notes
        run: |
          if [[ -f /tmp/release-notes.md ]]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ Release notes file exists"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "‚ùå Release notes file not found"
          fi

      - name: Display generated release notes
        if: steps.check-notes.outputs.exists == 'true'
        run: |
          echo "## üìù Generated Release Notes"
          echo ""
          cat /tmp/release-notes.md

      - name: Create GitHub Release
        if: env.CREATE_GITHUB_RELEASE == 'true' && steps.check-notes.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ env.ENABLE_AUTO_RELEASE }}" != "true" ]]; then
            echo "ENABLE_AUTO_RELEASE is not true. Skipping release creation."
            exit 0
          fi

          if [[ ! -f /tmp/release-notes.md ]]; then
            echo "ERROR: Release notes file not found!"
            exit 1
          fi

          # „É™„É™„Éº„Çπ„ÅÆ‰ΩúÊàê
          gh release create "${{ steps.prev-tag.outputs.current_tag }}" \
            --notes-file /tmp/release-notes.md \
            --title "${{ steps.prev-tag.outputs.current_tag }}" \
            --latest

          echo "‚úÖ Release created successfully!"
