name: CLAUDE_CODE_GLM_DEV

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened]

# åŒã˜Issue/PRã§ã¯åŒæ™‚ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) ||
      (github.event_name == 'pull_request' && env.AUTO_REVIEW_PR == 'true')
    runs-on: ubuntu-latest

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰å¯èƒ½ï¼‰
    env:
      CREATE_AUTO_PR: "true"              # Issueã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼æ™‚ã«è‡ªå‹•ã§PRã‚’ä½œæˆã™ã‚‹ã‹ã©ã†ã‹
      INCLUDE_TASK_SUMMARY: "true"        # ã‚¿ã‚¹ã‚¯ã‚µãƒãƒªãƒ¼ï¼ˆ---ã‚ˆã‚Šå¾Œã‚ã®å ±å‘Šå†…å®¹ï¼‰ã‚’å«ã‚ã‚‹ã‹ã©ã†ã‹
      AUTO_REVIEW_PR: "true"              # PRä½œæˆæ™‚ã«è‡ªå‹•ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      # â˜…ã“ã“ã§ã€Œã“ã®å®Ÿè¡ŒãŒä½¿ã†ãƒ–ãƒ©ãƒ³ãƒåã€ã‚’æ±ºã‚æ‰“ã¡ã™ã‚‹
      - name: Compute branch name
        id: branch
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request_review_comment" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "name=claude-glm-dev-pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "name=claude-glm-dev-issue-${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - uses: anthropics/claude-code-action@v1
        with:
          trigger_phrase: "@claude"
          github_token: ${{ secrets.GH_PAT_ONIZUKA }}

          # â˜…ãƒ–ãƒ©ãƒ³ãƒåã‚’å›ºå®šï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãªã—ï¼‰
          branch_prefix: ""
          branch_name_template: ${{ steps.branch.outputs.name }}

          # â˜…è¿½åŠ ï¼šãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéç”¨ã«å¿…è¦
          anthropic_api_key: ${{ secrets.ZAI_API_KEY }}

        env:
          # GLMã«å‘ã‘ã‚‹è¨­å®š
          ANTHROPIC_BASE_URL: https://api.z.ai/api/anthropic
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ZAI_API_KEY }}
          API_TIMEOUT_MS: "3000000"
          ANTHROPIC_DEFAULT_OPUS_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_SONNET_MODEL: "glm-4.7"
          ANTHROPIC_DEFAULT_HAIKU_MODEL: "glm-4.5-air"

      # â˜…Issueã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã•ã‚ŒãŸå ´åˆã®ã¿ã€è‡ªå‹•ã§PRã‚’ä½œæˆ
      - name: Create PR (if from issue)
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT_ONIZUKA }}
        run: |
          # ç’°å¢ƒå¤‰æ•°ã§PRä½œæˆã‚’åˆ¶å¾¡
          if [[ "${{ env.CREATE_AUTO_PR }}" != "true" ]]; then
            echo "CREATE_AUTO_PR is not true. Skipping PR creation."
            exit 0
          fi

          # INCLUDE_TASK_SUMMARY ã¯ job ãƒ¬ãƒ™ãƒ«ã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ç¶™æ‰¿
          python3 .github/scripts/create-pr.py \
            "${{ steps.branch.outputs.name }}" \
            "${{ github.event.issue.number }}"

  # â˜…PRãŒä½œæˆã•ã‚ŒãŸæ™‚ã«è‡ªå‹•ã§é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
  auto_comment:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
    env:
      AUTO_REVIEW_COMMENT: "true"         # PRä½œæˆæ™‚ã«è‡ªå‹•ã§é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã™ã‚‹ã‹ã©ã†ã‹

    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Post review request comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç’°å¢ƒå¤‰æ•°ã§ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’åˆ¶å¾¡
          if [[ "${{ env.AUTO_REVIEW_COMMENT }}" != "true" ]]; then
            echo "AUTO_REVIEW_COMMENT is not true. Skipping comment."
            exit 0
          fi

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ğŸ¤– è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚"
